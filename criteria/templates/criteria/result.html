{% extends "criteria/base.html" %}

{% block title %}Kết quả{% endblock %}

{% block content %}
  <h1>Kết quả tính điểm</h1>

  <div class="card">
    {% if not result.eligible %}
      <div class="pill danger">Không đủ điều kiện</div>
      <p><strong>Lý do:</strong> {{ result.ineligible_reason }}</p>
      <p class="muted">{{ result.risk_note }}</p>
    {% else %}
      <p>
        <strong>Tổng điểm:</strong> <span class="mono">{{ result.total_score }}</span>
        {% if result.meets_classification %}
          <span class="pill">Đủ tiêu chuẩn phân loại (≥ 10)</span>
        {% else %}
          <span class="pill danger">Chưa đủ tiêu chuẩn (&lt; 10)</span>
        {% endif %}
      </p>

      {% if result.risk_tier == "SLE Nguy cơ cao / Ominous" %}
        <p><strong>Phân tầng:</strong> <span class="pill danger">{{ result.risk_tier }}</span></p>
      {% else %}
        <p><strong>Phân tầng:</strong> <span class="pill">{{ result.risk_tier }}</span></p>
      {% endif %}
      <p class="muted">{{ result.risk_note }}</p>
    {% endif %}
  </div>

  {% if result.eligible and result.domain_scores %}
    <h2>Radar (Spider Chart) theo miền</h2>
    {{ radar_axes|json_script:"radar-axes" }}
    <div class="card">
      <div class="cols" style="grid-template-columns: 1fr;">
        <div>
          <canvas id="radarCanvas" width="760" height="520" style="width:100%; max-width: 920px; height:auto;"></canvas>
          <div class="muted small" style="margin-top:8px;">
            Mỗi trục là một miền; vùng xanh là điểm đạt được (scaled theo điểm tối đa của miền).
          </div>
        </div>
      </div>
    </div>
    <script>
      (function () {
        const el = document.getElementById("radar-axes");
        const canvas = document.getElementById("radarCanvas");
        if (!el || !canvas) return;
        const axes = JSON.parse(el.textContent || "[]");
        const ctx = canvas.getContext("2d");
        if (!ctx || !axes.length) return;

        // Handle HiDPI
        const dpr = window.devicePixelRatio || 1;
        const cssW = canvas.clientWidth || 760;
        const cssH = Math.max(420, Math.round(cssW * 0.68));
        canvas.style.width = cssW + "px";
        canvas.style.height = cssH + "px";
        canvas.width = Math.floor(cssW * dpr);
        canvas.height = Math.floor(cssH * dpr);
        ctx.scale(dpr, dpr);

        const W = cssW, H = cssH;
        const cx = W * 0.5, cy = H * 0.52;
        const r = Math.min(W, H) * 0.33;
        const N = axes.length;
        const startAngle = -Math.PI / 2;

        function polar(i, radius) {
          const a = startAngle + (i * 2 * Math.PI) / N;
          return { x: cx + Math.cos(a) * radius, y: cy + Math.sin(a) * radius };
        }

        function drawText(text, x, y, align) {
          ctx.textAlign = align || "center";
          ctx.textBaseline = "middle";
          ctx.fillText(text, x, y);
        }

        // Background
        ctx.clearRect(0, 0, W, H);
        ctx.fillStyle = "#ffffff";
        ctx.fillRect(0, 0, W, H);

        // Grid levels
        const levels = 5;
        for (let lv = 1; lv <= levels; lv++) {
          const rr = (r * lv) / levels;
          ctx.beginPath();
          for (let i = 0; i < N; i++) {
            const p = polar(i, rr);
            if (i === 0) ctx.moveTo(p.x, p.y);
            else ctx.lineTo(p.x, p.y);
          }
          ctx.closePath();
          ctx.strokeStyle = "#e5e7eb";
          ctx.lineWidth = 1;
          ctx.stroke();
        }

        // Axes lines + labels
        ctx.font = "12px ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial";
        for (let i = 0; i < N; i++) {
          const p = polar(i, r);
          ctx.beginPath();
          ctx.moveTo(cx, cy);
          ctx.lineTo(p.x, p.y);
          ctx.strokeStyle = "#e5e7eb";
          ctx.stroke();

          const label = String(axes[i].label || axes[i].id || "");
          // Shorten label to avoid overlap
          const short = label.replace(/\s+\(.*\)$/, "");
          const lp = polar(i, r + 18);
          const align = lp.x < cx - 10 ? "right" : lp.x > cx + 10 ? "left" : "center";
          ctx.fillStyle = "#111";
          drawText(short, lp.x, lp.y, align);
        }

        // Data polygon
        ctx.beginPath();
        for (let i = 0; i < N; i++) {
          const max = Math.max(1, Number(axes[i].max || 1));
          const val = Math.max(0, Number(axes[i].value || 0));
          const rr = (val / max) * r;
          const p = polar(i, rr);
          if (i === 0) ctx.moveTo(p.x, p.y);
          else ctx.lineTo(p.x, p.y);
        }
        ctx.closePath();
        ctx.fillStyle = "rgba(37, 99, 235, 0.18)";
        ctx.strokeStyle = "rgba(37, 99, 235, 0.95)";
        ctx.lineWidth = 2;
        ctx.fill();
        ctx.stroke();

        // Points + value labels (hide zeros to avoid clutter in the center)
        ctx.font = "11px ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial";
        for (let i = 0; i < N; i++) {
          const max = Math.max(1, Number(axes[i].max || 1));
          const val = Math.max(0, Number(axes[i].value || 0));
          if (val === 0) continue;
          const rr = (val / max) * r;
          const p = polar(i, rr);
          ctx.beginPath();
          ctx.arc(p.x, p.y, 3.5, 0, Math.PI * 2);
          ctx.fillStyle = "rgba(37, 99, 235, 1)";
          ctx.fill();
          ctx.fillStyle = "#334155";
          const tp = polar(i, rr + 12);
          drawText(`${val}/${max}`, tp.x, tp.y, "center");
        }
      })();
    </script>
  {% endif %}

  {% if result.domain_scores %}
    <h2>Chi tiết theo miền (Max-in-Domain)</h2>
    <div class="grid">
      {% for ds in result.domain_scores %}
        <section class="domain">
          <div class="domain-title">
            <strong>{{ ds.domain_label }}</strong>
            <span class="pill">+{{ ds.awarded_points }}</span>
          </div>
          {% if ds.note %}
            <div class="note">{{ ds.note }}</div>
          {% endif %}
          {% if ds.selected_criteria %}
            <div class="small">
              <div><strong>Đã chọn:</strong></div>
              <ul>
                {% for c in ds.selected_criteria %}
                  <li>{{ c.label }} ({{ c.points }} điểm)</li>
                {% endfor %}
              </ul>
              {% if ds.awarded_criterion %}
                <div class="muted">Tính điểm: {{ ds.awarded_criterion.label }} (MAX)</div>
              {% endif %}
            </div>
          {% else %}
            <div class="muted small">Không chọn tiêu chí nào trong miền này.</div>
          {% endif %}
        </section>
      {% endfor %}
    </div>
  {% endif %}

  <div class="actions">
    <a href="{% url 'criteria:index' %}">← Tính lại</a>
  </div>
{% endblock %}


